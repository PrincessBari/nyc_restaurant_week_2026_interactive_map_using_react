<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Restaurant Week 2026</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    
    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #root {
            width: 100%;
            height: 100%;
        }
        
        /* Desktop styles */
        .filter-panel {
            position: fixed;
            top: 10px;
            left: 60px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 9999;
            max-width: 350px;
        }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            .filter-panel {
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                max-width: none;
                border-radius: 16px 16px 0 0;
                box-shadow: 0 -2px 12px rgba(0,0,0,0.3);
                max-height: 60vh;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function RestaurantMap() {
            const [restaurantsData, setRestaurantsData] = useState([]);
            const [selectedCuisine, setSelectedCuisine] = useState('all');
            const [searchText, setSearchText] = useState('');
            const [filteredRestaurants, setFilteredRestaurants] = useState([]);
            const [map, setMap] = useState(null);
            const [markers, setMarkers] = useState([]);
            const mapContainerRef = useRef(null);

            // Load restaurant data from JSON file
            useEffect(() => {
                console.log('Fetching restaurant data...');
                fetch('restaurants.json')
                    .then(response => {
                        console.log('Response received:', response);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Data loaded successfully!');
                        console.log('Number of restaurants:', data.length);
                        console.log('First restaurant:', data[0]);
                        setRestaurantsData(data);
                        setFilteredRestaurants(data);
                    })
                    .catch(error => {
                        console.error('Error loading restaurant data:', error);
                    });
            }, []);

            const cuisines = [...new Set(restaurantsData.map(r => r.Cuisine))].sort();

            // Initialize map
            useEffect(() => {
                if (!mapContainerRef.current || map) return;

                console.log('Initializing map...');
                const mapInstance = L.map(mapContainerRef.current, {
                    center: [40.7429, -73.9803],
                    zoom: 12,
                    zoomControl: true
                });

                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 20
                }).addTo(mapInstance);

                console.log('Map initialized!');
                setMap(mapInstance);

                return () => {
                    if (mapInstance) {
                        mapInstance.remove();
                    }
                };
            }, []);

            // Update markers when filters change
            useEffect(() => {
                console.log('Marker update effect triggered');
                console.log('Map exists?', !!map);
                console.log('Restaurant data length:', restaurantsData.length);
                
                if (!map || restaurantsData.length === 0) {
                    console.log('Returning early - map or data not ready');
                    return;
                }

                const filtered = restaurantsData.filter(restaurant => {
                    const cuisineMatch = selectedCuisine === 'all' || restaurant.Cuisine === selectedCuisine;
                    const searchMatch = searchText === '' || restaurant.Restaurant.toLowerCase().includes(searchText.toLowerCase());
                    return cuisineMatch && searchMatch;
                });

                console.log('Filtered restaurants:', filtered.length);
                console.log('First filtered restaurant:', filtered[0]);
                setFilteredRestaurants(filtered);

                // Clear existing markers
                console.log('Clearing', markers.length, 'existing markers');
                markers.forEach(marker => map.removeLayer(marker));

                // Create new markers
                console.log('Creating markers for', filtered.length, 'restaurants');
                const newMarkers = filtered.map((restaurant, index) => {
                    if (index < 3) {
                        console.log(`Creating marker ${index}:`, restaurant.Restaurant, 'at', restaurant.Latitude, restaurant.Longitude);
                    }
                    
                    const marker = L.marker([restaurant.Latitude, restaurant.Longitude], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);

                    marker.bindTooltip(`
                        <div style="font-family: Arial; font-size: 12px;">
                            <strong>${restaurant.Restaurant}</strong><br>
                            <em>Cuisine:</em> ${restaurant.Cuisine}<br>
                            <em>Address:</em> ${restaurant.Address}
                        </div>
                    `, {
                        permanent: false,
                        direction: 'top',
                        opacity: 0.9
                    });

                    return marker;
                });

                console.log('Created', newMarkers.length, 'markers');
                setMarkers(newMarkers);

                // Fit bounds to markers
                if (filtered.length > 0) {
                    const bounds = L.latLngBounds(filtered.map(r => [r.Latitude, r.Longitude]));
                    console.log('Fitting map to bounds:', bounds);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }, [map, selectedCuisine, searchText, restaurantsData]);

            const handleReset = () => {
                setSelectedCuisine('all');
                setSearchText('');
            };

            return (
                <div style={{ width: '100%', height: '100%', position: 'relative' }}>
                    <div
                        ref={mapContainerRef}
                        style={{
                            position: 'absolute',
                            top: 0,
                            bottom: 0,
                            left: 0,
                            right: 0
                        }}
                    />

                    <div className="filter-panel">
                        <h3 style={{ margin: '0 0 10px 0', fontSize: '20px', color: '#333' }}>
                            <strong>NYC Restaurant Week 2026</strong><br />
                            <span style={{ fontSize: '16px', fontWeight: 'normal' }}>Jan. 20th - Feb. 12th</span>
                        </h3>

                        <label style={{ display: 'block', margin: '10px 0 5px 0', fontWeight: 'bold', fontSize: '14px' }}>
                            Filter by Cuisine:
                        </label>
                        <select
                            value={selectedCuisine}
                            onChange={(e) => setSelectedCuisine(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '8px',
                                border: '1px solid #ddd',
                                borderRadius: '4px',
                                fontSize: '14px'
                            }}
                        >
                            <option value="all">All Cuisines</option>
                            {cuisines.map(cuisine => (
                                <option key={cuisine} value={cuisine}>{cuisine}</option>
                            ))}
                        </select>

                        <label style={{ display: 'block', margin: '10px 0 5px 0', fontWeight: 'bold', fontSize: '14px' }}>
                            Search Restaurant:
                        </label>
                        <input
                            type="text"
                            value={searchText}
                            onChange={(e) => setSearchText(e.target.value)}
                            placeholder="Type restaurant name..."
                            style={{
                                width: '100%',
                                padding: '8px',
                                border: '1px solid #ddd',
                                borderRadius: '4px',
                                fontSize: '14px'
                            }}
                        />

                        <button
                            onClick={handleReset}
                            style={{
                                width: '100%',
                                padding: '10px',
                                marginTop: '10px',
                                background: '#64B5F6',
                                color: 'white',
                                border: 'none',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: 'bold'
                            }}
                        >
                            Reset Filters
                        </button>

                        <div style={{
                            fontSize: '12px',
                            color: '#666',
                            marginTop: '10px',
                            paddingTop: '10px',
                            borderTop: '1px solid #eee'
                        }}>
                            Showing <strong style={{ color: '#2196F3' }}>{filteredRestaurants.length}</strong> restaurants
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<RestaurantMap />, document.getElementById('root'));
    </script>
</body>
</html>
